{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block branding %}
<h1 id="site-name"><a href="{% url 'admin:index' %}">{{ site_header|default:_('Django administration') }}</a></h1>
{% endblock %}

{% block content %}
<style>
    .dashboard-container {
        padding: 20px;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .metric-card h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-card .value {
        font-size: 32px;
        font-weight: bold;
        color: #333;
        margin: 10px 0;
    }

    .metric-card .subtext {
        font-size: 12px;
        color: #999;
    }

    .metric-card.success .value { color: #28a745; }
    .metric-card.warning .value { color: #ffc107; }
    .metric-card.danger .value { color: #dc3545; }
    .metric-card.info .value { color: #17a2b8; }

    .alert-box {
        padding: 15px;
        margin-bottom: 20px;
        border-left: 4px solid;
        background: #f8f9fa;
    }

    .alert-box.danger {
        border-left-color: #dc3545;
        background: #f8d7da;
    }

    .alert-box.warning {
        border-left-color: #ffc107;
        background: #fff3cd;
    }

    .alert-box.info {
        border-left-color: #17a2b8;
        background: #d1ecf1;
    }

    .section {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .section h2 {
        margin-top: 0;
        font-size: 18px;
        border-bottom: 2px solid #417690;
        padding-bottom: 10px;
    }

    .activity-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .activity-list li {
        padding: 10px;
        border-bottom: 1px solid #eee;
    }

    .activity-list li:last-child {
        border-bottom: none;
    }

    .badge {
        display: inline-block;
        padding: 3px 8px;
        font-size: 11px;
        border-radius: 3px;
        font-weight: bold;
    }

    .badge-urgent { background: #dc3545; color: white; }
    .badge-high { background: #ffc107; color: #333; }
    .badge-medium { background: #17a2b8; color: white; }
    .badge-low { background: #6c757d; color: white; }
    .badge-open { background: #007bff; color: white; }
    .badge-in-progress { background: #ffc107; color: #333; }
    .badge-resolved { background: #28a745; color: white; }
</style>

<div class="dashboard-container">
    <h1 style="margin-bottom: 30px;">üõ†Ô∏è Customer Support Dashboard</h1>

    <!-- Alerts -->
    {% if alerts %}
        <div style="margin-bottom: 30px;">
            <h2>‚ö†Ô∏è Alerts & Notifications</h2>
            {% for alert in alerts %}
                <div class="alert-box {{ alert.type }}">
                    <strong>{{ alert.message }}</strong>
                    {% if alert.link %}
                        <a href="{{ alert.link }}" style="margin-left: 10px;">View ‚Üí</a>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- User Metrics -->
    <h2>üë• User Metrics</h2>
    <div class="metrics-grid">
        <div class="metric-card info">
            <h3>Total Users</h3>
            <div class="value">{{ total_users|default:0 }}</div>
            <div class="subtext">{{ new_users_24h }} new in 24h</div>
        </div>

        <div class="metric-card success">
            <h3>Verified Users</h3>
            <div class="value">{{ verified_users|default:0 }}</div>
            <div class="subtext">{{ verified_users|default:0 }}/{{ total_users|default:0 }} verified</div>
        </div>

        <div class="metric-card warning">
            <h3>Unverified</h3>
            <div class="value">{{ unverified_users|default:0 }}</div>
            <div class="subtext">{{ unverified_with_bvn }} with BVN</div>
        </div>

        <div class="metric-card success">
            <h3>Active Users</h3>
            <div class="value">{{ active_users|default:0 }}</div>
            <div class="subtext">Last 7 days: {{ new_users_7d }}</div>
        </div>
    </div>

    <!-- Wallet & Transaction Metrics -->
    <h2>üí∞ Wallet & Transactions</h2>
    <div class="metrics-grid">
        <div class="metric-card info">
            <h3>Total Wallets</h3>
            <div class="value">{{ total_wallets|default:0 }}</div>
            <div class="subtext">Active wallet accounts</div>
        </div>

        <div class="metric-card success">
            <h3>Total Balance</h3>
            <div class="value">‚Ç¶{{ total_balance|floatformat:2 }}</div>
            <div class="subtext">Across all wallets</div>
        </div>

        <div class="metric-card info">
            <h3>Transactions (24h)</h3>
            <div class="value">{{ transactions_24h|default:0 }}</div>
            <div class="subtext">Last 24 hours</div>
        </div>

        <div class="metric-card {% if pending_withdrawals > 10 %}warning{% else %}info{% endif %}">
            <h3>Pending Withdrawals</h3>
            <div class="value">{{ pending_withdrawals|default:0 }}</div>
            <div class="subtext">{{ failed_withdrawals_24h }} failed in 24h</div>
        </div>
    </div>

    <!-- Support Metrics -->
    <h2>üìû Support Metrics</h2>
    <div class="metrics-grid">
        <div class="metric-card {% if open_notes > 20 %}warning{% else %}info{% endif %}">
            <h3>Open Notes</h3>
            <div class="value">{{ open_notes|default:0 }}</div>
            <div class="subtext">{{ notes_created_24h }} created in 24h</div>
        </div>

        <div class="metric-card warning">
            <h3>In Progress</h3>
            <div class="value">{{ in_progress_notes|default:0 }}</div>
            <div class="subtext">Being worked on</div>
        </div>

        <div class="metric-card {% if urgent_notes > 0 %}danger{% else %}success{% endif %}">
            <h3>Urgent</h3>
            <div class="value">{{ urgent_notes|default:0 }}</div>
            <div class="subtext">{{ flagged_notes }} flagged</div>
        </div>

        <div class="metric-card success">
            <h3>Resolved (24h)</h3>
            <div class="value">{{ notes_resolved_24h|default:0 }}</div>
            <div class="subtext">Last 24 hours</div>
        </div>
    </div>

    <!-- System Health -->
    <h2>üè• System Health</h2>
    <div class="metrics-grid">
        <div class="metric-card info">
            <h3>Active Sessions</h3>
            <div class="value">{{ active_sessions|default:0 }}</div>
            <div class="subtext">{{ new_sessions_24h }} new in 24h</div>
        </div>

        <div class="metric-card success">
            <h3>Active Savings Goals</h3>
            <div class="value">{{ active_savings_goals|default:0 }}</div>
            <div class="subtext">‚Ç¶{{ total_savings|floatformat:2 }} saved</div>
        </div>

        <div class="metric-card {% if errors_24h > 50 %}danger{% elif errors_24h > 10 %}warning{% else %}success{% endif %}">
            <h3>Errors (24h)</h3>
            <div class="value">{{ errors_24h|default:0 }}</div>
            <div class="subtext">Last 24 hours</div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 30px;">

        <!-- Recent Customer Notes -->
        <div class="section">
            <h2>üìù Recent Customer Notes</h2>
            {% if recent_notes %}
                <ul class="activity-list">
                    {% for note in recent_notes %}
                        <li>
                            <strong>{{ note.user.email }}</strong>
                            <span class="badge badge-{{ note.priority }}">{{ note.priority }}</span>
                            <span class="badge badge-{{ note.status }}">{{ note.status }}</span>
                            <br>
                            <small>{{ note.subject }}</small>
                            <br>
                            <small style="color: #999;">{{ note.created_at|timesince }} ago</small>
                            <a href="/admin/account/customernote/{{ note.id }}/change/" style="float: right;">View ‚Üí</a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p style="color: #999;">No recent customer notes</p>
            {% endif %}
            <a href="/admin/account/customernote/" style="display: block; margin-top: 15px; text-align: right;">View All ‚Üí</a>
        </div>

        <!-- Recent Unverified Users -->
        <div class="section">
            <h2>‚è≥ Users Awaiting Verification</h2>
            {% if recent_unverified %}
                <ul class="activity-list">
                    {% for user in recent_unverified %}
                        <li>
                            <strong>{{ user.email }}</strong>
                            {% if user.has_bvn %}<span class="badge" style="background: #28a745; color: white;">Has BVN</span>{% endif %}
                            <br>
                            <small>{{ user.first_name }} {{ user.last_name }}</small>
                            <br>
                            <small style="color: #999;">Registered {{ user.created_at|timesince }} ago</small>
                            <a href="/admin/account/usermodel/{{ user.id }}/change/" style="float: right;">Verify ‚Üí</a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p style="color: #999;">No users awaiting verification</p>
            {% endif %}
            <a href="/admin/account/usermodel/?is_verified__exact=0&has_bvn__exact=1" style="display: block; margin-top: 15px; text-align: right;">View All ‚Üí</a>
        </div>

        <!-- Recent Failed Withdrawals -->
        <div class="section">
            <h2>‚ùå Recent Failed Withdrawals</h2>
            {% if recent_failed_withdrawals %}
                <ul class="activity-list">
                    {% for withdrawal in recent_failed_withdrawals %}
                        <li>
                            <strong>{{ withdrawal.user.email }}</strong>
                            <span class="badge badge-urgent">Failed</span>
                            <br>
                            <small>Amount: ‚Ç¶{{ withdrawal.amount|floatformat:2 }}</small>
                            <br>
                            <small style="color: #999;">{{ withdrawal.created_at|timesince }} ago</small>
                            <a href="/admin/wallet/withdrawalrequest/{{ withdrawal.id }}/change/" style="float: right;">View ‚Üí</a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p style="color: #999;">No recent failed withdrawals</p>
            {% endif %}
            <a href="/admin/wallet/withdrawalrequest/?status__exact=failed" style="display: block; margin-top: 15px; text-align: right;">View All ‚Üí</a>
        </div>

    </div>

    <!-- Quick Links -->
    <div class="section" style="margin-top: 30px;">
        <h2>üîó Quick Links</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
            <a href="/admin/account/usermodel/" style="display: block; padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; text-decoration: none;">üë• Manage Users</a>
            <a href="/admin/account/customernote/" style="display: block; padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; text-decoration: none;">üìù Customer Notes</a>
            <a href="/admin/wallet/withdrawalrequest/" style="display: block; padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; text-decoration: none;">üí∏ Withdrawals</a>
            <a href="/admin/wallet/wallettransaction/" style="display: block; padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; text-decoration: none;">üí≥ Transactions</a>
            <a href="/admin/account/usersession/" style="display: block; padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; text-decoration: none;">üîê Sessions</a>
            <a href="/admin/core/serverlog/" style="display: block; padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; text-decoration: none;">üìä Server Logs</a>
        </div>
    </div>

</div>

{% endblock %}
